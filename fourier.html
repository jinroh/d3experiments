<!DOCTYPE html>
<head>
<meta charset="utf-8">
<style>
body {
  font: 13px/13px "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: auto;
  position: relative;
  width: 960px;
}
form {
  position: absolute;
  bottom: 10px;
  right: 10px;
}
.hide {
  display: none;
}
.dot {
  fill: hsla(207, 63%, 27%, 0.2);
}
.dot.last {
  fill: hsla(207, 63%, 27%, 1.0);
}
.coeff {
  fill: none;
  stroke: hsl(0, 0%, 70%);
}
.coeff.first {
  fill: none;
  stroke: hsl(0, 0%, 30%);
}
.coeff.last {
  display: none;
}
.graph {
  fill: none;
  stroke: steelblue;
  stroke-width: 3px;
}
.trace {
  fill: none;
  stroke: steelblue;
}
.proj {
  fill: none;
  stroke: #000;
}
.axis {
  stroke: hsl(0, 0%, 70%);
}
</style>
</head>
<body>
<form>
  <p>
    <input id="play" type="checkbox" value="1" checked>
    <select id="type">
      <option value="square">Square</option>
      <option value="triangle">Triangle</option>
      <option value="sawtooth">Sawtooth</option>
      <option value="fibonacci">Fibonacci</option>
      <option value="pulse">Pulse</option>
    </select>
  </p>
  <p><input id="size" type="range" value="6" min="1" max="100" step="1"> <label>Precision</label></p>
  <p><input id="freq" type="range" value="0.3" min="0.01" max="0.5" step="0.01"> <label>Speed</label></p>
</form>
<script src="d3.js"></script>
<script>
(function() {
  'use strict';

  var π = Math.PI
  var τ = 2 * Math.PI

  var types = {
    square: function(n) {
      return (((n + 1) % 2) ? 0 : 1) / n;
    },
    triangle: function(n) {
      if (!(n % 2)) return 0;
      return ((n % 4 === 1) ? 1 : -1) / (n * n);
    },
    sawtooth: function(n) {
      return ((n % 2) ? -1 : 1) / (n + 1);
    },
    fibonacci: function(n) {
      var fst = 0.01, sec = 0.01, add;
      for (var i = 0; i < n; i++) {
        add = fst + sec;
        fst = sec;
        sec = add;
      }
      return add;
    },
    pulse: function(n) {
      return 0.1;
    }
  };

  function FT(N, s) {
    return function(x) {
      var n = -1, y = 0;
      while (++n < N) {
        y += A[n] * s(τ * (n + 1) * x);
      }
      return y;
    }
  }

  var
    margin = {top: 40, right: 100, bottom: 40, left: 150},
    W = 960,
    H = 500,
    w = W - margin.left - margin.right,
    h = H - margin.top - margin.bottom,

    radius = 140,
    theta  = 0,
    xmax   = 2,
    rate   = 1 / 60,

    tDomain = d3.range(0, 1, 1 / 1000),   // trace domain
    gDomain = d3.range(0, xmax, xmax / 1000), // graph domain

    C = types.square, // coeffiecients
    L = 6,            // size
    F = 0.3,          // frequence

    yCirc = d3.scale.linear().domain([-1, 1]).range([h/2 + radius, h/2 - radius]),
    xCirc = d3.scale.linear().domain([-1, 1]).range([0, 2 * radius]),
    rAxis = d3.scale.linear().domain([0, 1]).range([0, radius]),
    xAxis = d3.scale.linear().domain([0, xmax]).range([radius, W]),

    A, Fxy, fx, fy,

    timer, data = [];

  var graph = d3.svg.line()
    .x(function(d) { return xAxis(d); })
    .y(function(d) { return yCirc(fy(theta - d)); });

  var proj = d3.svg.line()
    .x(function(d) { return xCirc(d.x); })
    .y(function(d) { return yCirc(d.y); });

  var trace = d3.svg.line()
    .x(function(d) { return xCirc(fx(d)); })
    .y(function(d) { return yCirc(fy(d)); });

  var svg = d3.select("body")
    .append("svg")
      .attr("width", W)
      .attr("height", H)

  svg.append('line')
    .attr('class', 'axis')
    .attr('y1', margin.top + yCirc(0)).attr('x1', 0)
    .attr('y2', margin.top + yCirc(0)).attr('x2', W);

  svg.append('line')
    .attr('class', 'axis')
    .attr('x1', margin.left + xCirc(0)).attr('y1', 0)
    .attr('x2', margin.left + xCirc(0)).attr('y2', H);

  var vis = svg.append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var gPath = vis.append("path").attr("class", "graph");
  var tPath = vis.append("path").attr("class", "trace");
  var pPath = vis.append("path").attr("class", "proj");

  function cache() {
    if (typeof C === 'function') {
      A = d3.range(1, L + 1).map(C);
    } else {
      A = C.slice(0, L);
    }

    fx = FT(L - 1, Math.cos);
    fy = FT(L - 1, Math.sin),

    Fxy = A.map(function(a, i) {
      return { X: FT(i, Math.cos), Y: FT(i, Math.sin) };
    });

    tPath.attr("d", trace(tDomain));
  }

  function calc() {
    if (!Fxy) cache();
    Fxy.forEach(function(f, i) {
      var d = data[i] || (data[i] = {x:0,y:0,r:0});
      d.x = f.X(theta);
      d.y = f.Y(theta);
      d.r = Math.abs(A[i]);
      d.f = i / τ;
    });
    data.length = Fxy.length;
  }

  function circles() {
    var c = vis.selectAll(".coeff").data(data);
    c.exit().remove();
    c.enter().append("circle").attr("class", "coeff");
    return c;
  }

  function dots() {
    var d = vis.selectAll(".dot").data(data);
    d.exit().remove();
    d.enter().append("circle").attr("class", "dot").attr("r", 3);
    return d;
  }

  function drawGraph() {
    calc();

    circles()
      .attr("cx", function(d) { return xCirc(d.x); })
      .attr("cy", function(d) { return yCirc(d.y); })
      .attr("r",  function(d) { return rAxis(d.r); })
      .classed("last", function(d, i) { return i === L - 1; })
      .classed("first", function(d, i) { return i === 0; });

    dots()
      .attr("cx", function(d) { return xCirc(d.x); })
      .attr("cy", function(d) { return yCirc(d.y); })
      .classed("hide", function(d) { return d.r === 0; })
      .classed("last", function(d, i) { return i === L - 1; });

    var last = data[data.length - 1];
    pPath.attr("d", proj([last, {x:0,y:last.y}]));
    gPath.attr("d", graph(gDomain));
  }

  var draw;

  function drawHisto() {
    calc();

    circles().transition()
      .attr("cx", function(d) { return xAxis(d.f); })
      .attr("cy", yCirc(0))
      .attr("r",  function(d) { return rAxis(d.r); });

    dots()
      .classed("hide", function(d) { return d.r === 0; })
      .transition()
      .attr("cx", function(d) { return xAxis(d.f); })
      .attr("cy", yCirc(0));

    pPath.attr("d", "");
    tPath.attr("d", "");
    gPath.attr("d", "");
  }

  function redraw() {
    cache();
    draw();
  }

  function play() {
    if (timer) return;
    draw = drawGraph;
    (function loop() {
      draw();
      theta += F * rate;
      timer = setTimeout(loop, rate * 1000);
    })();
  }

  function pause() {
    if (!timer) return;
    clearTimeout(timer);
    timer = null;
    draw = drawHisto;
    draw();
  }

  d3.select("#play").on("change", function() { this.checked ? play() : pause(); });
  d3.select("#freq").on("change", function() { F = +this.value; redraw(); });
  d3.select("#size").on("change", function() { L = +this.value; redraw(); });
  d3.select("#type").on("change", function() { C = types[this.value]; redraw(); });

  play();

})();
</script>
</body>
